<!DOCTYPE html><html lang="ZH-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="referrer" content="no-referrer"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1,user-scalable=no,viewport-fit=cover"><meta name="author" content="椎咲良田"><meta name="copyright" content="椎咲良田"><meta name="og:image" content="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/avatar.jpg"><meta name="og:type" content="website"><meta name="og:site_name" content="椎咲良田"><meta name="og:url" content="sanshiliuxiao.top"><meta name="og：title" content="椎咲良田"><meta name="theme-color" content="#b854d4"><title>椎咲良田</title><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/favicon.jpg" type="image/x-icon"><link rel="stylesheet" href="/css/index.css?version=2.0.0"><link rel="stylesheet" href="/font/fontello.css?version=2.0.0"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Fira+Mono|Noto+Serif+SC&amp;amp;display=swap"><link rel="canonical" href="//sanshiliuxiao.top"><link rel="dns-prefetch" href="//cdn.jsdelivr.net"><link rel="stylesheet" href="/lib/gitalk/gitalk.min.css"><script src="/lib/gitalk/gitalk.min.js"></script><script src="/lib/valine/Valine.min.js">   </script></head><body><div class="layout"><header><div class="header"><div class="mobile-bg" style="background-image:url(https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/mobile.png);"></div><h1 class="title">椎咲良田</h1><h2 class="subtitle">快走吧 趁风停止之前</h2><nav class="menu"><a class="menu-item pjax-main-link" href="/"><li><i class="icon-index"></i><span>首页</span></li></a><a class="menu-item pjax-main-link" href="/archives/"><li><i class="icon-archives"></i><span>归档</span></li></a><a class="menu-item pjax-main-link" href="/categories/"><li><i class="icon-categories"></i><span>分类</span></li></a><a class="menu-item pjax-main-link" href="/tags/"><li><i class="icon-tags"></i><span>标签</span></li></a><a class="menu-item pjax-main-link" href="/books/"><li><i class="icon-books"></i><span>书单</span></li></a><a class="menu-item pjax-main-link" href="/inspirations/"><li><i class="icon-inspiration"></i><span>灵感</span></li></a><a class="menu-item pjax-main-link" href="/friends/"><li><i class="icon-friends"></i><span>友链</span></li></a><a class="menu-item pjax-main-link" href="/about/"><li><i class="icon-about"></i><span>关于</span></li></a></nav></div></header><main><div class="main-wrapper"></div><div class="pjax-main-page"><div class="post"><article class="post-article"><div class="post-header"><img class="default-image" src="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/postDefaultImage .png" style="opacity:0;"><img class="post-image" src="https://i.loli.net/2019/03/07/5c80d1795002a.jpg"><div class="post-head"><div class="post-title-wrapper"><h1 class="post-title">世界线变动率探测仪时钟</h1></div><div class="post-meta"><span class="post-date"><i class="icon-calendar"></i><span class="date timeago" datetime="2019-03-07T06:10:37.000Z"></span></span><span class="post-hot"><i class="icon-fire"></i><span class="leancloud_visitors" id="/notebook/JavaScript/20190307-世界线变动率探测仪/" data-flag-title="世界线变动率探测仪时钟">热度<span class="leancloud-visitors-count">0</span>℃</span></span><span class="post-tags"><i class="icon-tag"></i><span class="tag">JavaScript</span><span class="tag">命运石之门</span></span><span class="post-categories"><i class="icon-bookmark-empty"></i><span class="category">笔记本</span></span></div></div></div><div class="post-content heti"><div class="markdown"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这是一个具有世界线变动率探测仪效果的时钟。<br>代码在三个月前就已经写完了，这次拿出了，重新回顾一番。</p>
<blockquote>
<p>代码仓库：<a href="https://github.com/sanshiliuxiao/el_psy_congroo" target="_blank" rel="noopener">https://github.com/sanshiliuxiao/el_psy_congroo</a><br>在线访问地址：<a href="https://sanshiliuxiao.top/el_psy_congroo/">https://sanshiliuxiao.top/el_psy_congroo/</a></p>
</blockquote>
<p>众所周知，一个页面大概都会有<code>HTML</code>、<code>CSS</code>和<code>JavaScript</code>。</p>
<h2 id="HTML"><a href="#HTML" class="headerlink" title="HTML"></a>HTML</h2><p>这方面特别的简单，就是一个核心的容器和八张图片容器。</p>
<pre><code class="html">body &gt; .el_psy_congroo &gt; .img-wrapper*8</code></pre>
<h2 id="CSS"><a href="#CSS" class="headerlink" title="CSS"></a>CSS</h2><p>主要是全屏和自适应。使用了flex布局是真的爽。</p>
<pre><code class="css">/* 简单的 reset */
html, body, div, span, img {
  margin: 0;
  padding: 0;
  border: 0;
  font-size: 100%;
  font: inherit;
  vertical-align: baseline;
}
/* 全屏 */
html, body {
  width: 100%;
  height: 100%;
  line-height: 1;
  overflow: hidden;
  display: flex;
  justify-content: center;
  align-items: center;
  background: rgba(26, 5, 3);
}
.el_psy_congroo {
  display: flex;
}
/* 这里使用 rem 配合 js ，实现自适应 */
/* 使用width 和 padding-top 实现图片容器的宽高比 */
.img-wrapper {
  width: 1rem;
  padding-top: 3rem;
  position: relative;
  transition: all .5s ease-out;
}
/* 图片由 js 动态插入 img-wrapper */
/* 使用绝对定位 */
img {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  transition: all .5s ease-out;
}</code></pre>
<h2 id="JavaScript"><a href="#JavaScript" class="headerlink" title="JavaScript"></a>JavaScript</h2><p>最核心的<code>JavaScript</code>, 交互就是要靠它来实现。就语法而言，使用了一些ES6的语法，超好用。</p>
<blockquote>
<p>整个<code>JavaScript</code>代码的大致的逻辑<br>监听<code>load</code>事件 -&gt; 加载所有图片 -&gt; 触发自定义事件 -&gt; 探测仪效果 -&gt; 开启时钟 -&gt; 刷新时钟<br>在时钟运行过程中，监听<code>reset</code>事件和<code>click</code>事件。当<code>click</code>事件触发，继续触发自定义事件。<br>自定义事件有两个<code>timeLineChangeStart</code>和<code>timeLineChangeEnd</code>。</p>
</blockquote>
<p>下面是部分代码解析。<br>图片是异步加载的，如果网速不好，直接一张一张加载图片，慢慢显示在页面上，会导致页面效果不好看，所以我选择了使用<code>Promise</code>方法，来保证所有图片都加载完毕后，再返回。</p>
<pre><code class="javascript">function allImgLoad() {
  let arrPromis = []
  for (let i=0; i&lt;13; ++i) {
    arrPromis[i] = new Promise((resolve) =&gt; {
      _imgAll[i] = new Image()
      if (_pattern === 1) {
        _imgAll[i].src = getImgFromLocalStorage(i)
      } else {
        _imgAll[i].src = &#39;./img/&#39; + i + &#39;.png&#39;
      }
      _imgAll[i].addEventListener(&#39;load&#39;, function() {
        resolve()
      })
    })
  }
  return Promise.all([...arrPromis])
}</code></pre>
<p>进一步的，如果下次，我不想从网络进行请求图片，而是从本地读取，会不会更快呢，所以想到了使用<code>localStorage</code>，5M的容量还是挺大的，而且现代浏览器都支持。这里我们把图片转变为<code>base64</code>进行保存。使用<code>cavas.toDataURL()</code>方法。而<code>base64</code>资源可以直接被<code>img.src</code>引用。</p>
<pre><code class="javascript">function saveImgInLocalStorage(name, img) {
  let canvas = document.createElement(&#39;canvas&#39;)
  canvas.width = img.width
  canvas.height = img.height
  let ctx = canvas.getContext(&#39;2d&#39;)
  ctx.drawImage(img, 0, 0)
  localStorage.setItem(name, canvas.toDataURL(&#39;image/png&#39;))
}
function getImgFromLocalStorage(name) {
  return localStorage.getItem(name)
}</code></pre>
<p>我们得往容器中插入和替换图片，这样才能产生效果呀，所以就封装了两个方法。</p>
<pre><code class="javascript">/* 添加节点 */
function appendNode(paNode, newNode) {
  paNode.appendChild(newNode)
}
/* 替换节点 */
function replaceNode(paNode, newNode) {
  paNode.innerHTML = &#39;&#39;
  paNode.appendChild(newNode)
}</code></pre>
<p>时钟的功能，使用<code>setTimeout()</code>去模拟<code>setInterval()</code>。同时记录下定时器句柄，方便在时间线变动的时候，清除掉定时器。</p>
<pre><code class="javascript">function clock() {
  _timer = setTimeout(() =&gt; {
    const nowTime = new Date()
    let hour = nowTime.getHours()
    let mins = nowTime.getMinutes()
    let secs = nowTime.getSeconds()
    hour = hour &gt;= 10 ? hour.toString() : &#39;0&#39; + hour
    mins = mins &gt;= 10 ? mins.toString() : &#39;0&#39; + mins
    secs = secs &gt;= 10 ? secs.toString() : &#39;0&#39; + secs
    const time = hour + &#39;.&#39; + mins + &#39;.&#39; + secs
    for (let i=0; i&lt; time.length; ++i) {
      if ( time[i] !== &#39;.&#39;) {
        replaceNode(_imgWrapperNode[i], _imgAll[time[i]].cloneNode())
      }
    }
    if ( _flag === 0 ) {
      replaceNode(_imgWrapperNode[2],  _imgAll[11].cloneNode())
      replaceNode(_imgWrapperNode[5],  _imgAll[11].cloneNode())
    } else if (_flag === 1) {
      replaceNode(_imgWrapperNode[2],  _imgAll[12].cloneNode())
      replaceNode(_imgWrapperNode[5],  _imgAll[12].cloneNode())
    }
    _flag = _flag === 0 ? 1 : 0
    clock()
  }, 1000);
}</code></pre>
<p>时间线变动效果，依赖于两个自定义事件的触发。触发自定义<code>timeLineChangeStart</code>事件，清除定时器，开启世界线变动以检测仪效果，当变换完成，触发自定义<code>timeLineChangeEnd</code>事件、重新开启时钟功能。</p>
<pre><code class="javascript">// 生成自定义事件
const evt_change_start = new Event(&#39;timeLineChangeStart&#39;);
// 监听
window.addEventListener(&#39;timeLineChangeStart&#39;, () =&gt; timeLineChange())
// 触发
window.dispatchEvent(evt_change_start)</code></pre>
<p>至于其他代码部分，不做过多的叙述，基本上看源代码，能够很清晰的明白，各个函数和变量的作用。</p>
<div style="text-align : center"><!-- 歌曲名 --><p> </p><!--嵌入的音乐iframe --></div></div></div></article></div><div id="gitalk"></div><script>var gitalk = new Gitalk({
    clientID: 'df197d1e1761f7b45688',
    clientSecret: 'cfbd1df2464d6ce367281fdc437d60701867b30a',
    id: '2019-03-07 14:10:37',
    repo: 'comments',
    owner: 'sanshiliuxiao',
    admin: 'df197d1e1761f7b45688'
})
gitalk.render('gitalk')</script></div><div class="pjax-main-loading loading"><img class="loading-image" src="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/loading.gif"></div></main><footer><div class="footer site-info"><p><i class="icon-copyright"></i><span>2018</span>&minus;<span>2020</span>&nbsp;&nbsp;&nbsp;<i class="icon-heart"></i>&nbsp;&nbsp;<span>椎咲良田</span></p><p><a href="https://github.com/sanshiliuxiao/hexo-theme-aurora.git" target="_blank">hexo-theme-Aurora</a>&nbsp; | &nbsp;快走吧 趁风停止之前</p></div></footer></div><div class="bg"><div class="pc-dynamic-bg"><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/1.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/2.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/3.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/4.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/5.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/6.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/7.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/8.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/9.jpg"></span></div></div><span class="back-to-top"></span><div class="leancloud"><script src="/js/third-party/leancloud.min.js?version=2.0.0"></script><div class="leancloud-app-id" leancloud-app-id="QAIKomD08e9fmVRQP4tkzUDf-MdYXbMMI"></div><div class="leancloud-app-key" leancloud-app-key="vi0TViY0HvYocUR3HxKGd1l9"></div><div class="leancloud-app-hot"></div><div class="leancloud-app-visitor"></div></div><link rel="stylesheet" href="/lib/APlayer/APlayer.min.css"><script src="/lib/APlayer/APlayer.min.js"></script><div id="aplayer"></div><script>let list = JSON.parse('[{"name":"Once more","artist":"阿保剛","url":"https://files.catbox.moe/13boxb.mp3","cover":"https://i.loli.net/2019/04/18/5cb87157c617e.jpg"},{"name":"All or None","artist":"阿保剛","url":"https://files.catbox.moe/4x69y9.mp3","cover":"https://i.loli.net/2019/04/18/5cb87157b537a.jpg"},{"name":"Karma","artist":"阿保剛","url":"https://files.catbox.moe/r5dsuh.mp3","cover":"https://i.loli.net/2019/04/18/5cb871583cfb7.jpg"},{"name":"星の奏でる歌","artist":"阿保剛","url":"https://files.catbox.moe/m1wd57.mp3","cover":"https://i.loli.net/2019/04/18/5cb871585123b.jpg"}]')
  const ap = new APlayer({
      container: document.getElementById('aplayer'),
      theme: '#b28fce',
      audio: list,
      fixed: true
  });
  ap.list.show()
</script><script src="/js/third-party/jquery.min.js?version=2.0.0"></script><script src="/js/third-party/isMobile.min.js?version=2.0.0"></script><script src="/js/third-party/timeago.min.js?version=2.0.0"></script><script src="/js/third-party/pjax.min.js?version=2.0.0"></script><script src="/js/third-party/zooming.min.js?version=2.0.0"></script><script src="/js/third-party/backstretch.min.js?version=2.0.0"></script><script src="/js/highlight.min.js?version=2.0.0"></script><script src="/js/index.js?version=2.0.0"></script></body></html>