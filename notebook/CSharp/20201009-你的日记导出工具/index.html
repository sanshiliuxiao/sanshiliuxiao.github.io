<!DOCTYPE html><html lang="ZH-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="referrer" content="no-referrer"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1,user-scalable=no,viewport-fit=cover"><meta name="author" content="椎咲良田"><meta name="copyright" content="椎咲良田"><meta name="og:image" content="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/avatar.jpg"><meta name="og:type" content="website"><meta name="og:site_name" content="椎咲良田"><meta name="og:url" content="sanshiliuxiao.top"><meta name="og：title" content="椎咲良田"><meta name="theme-color" content="#b854d4"><title>椎咲良田</title><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/favicon.jpg" type="image/x-icon"><link rel="stylesheet" href="/css/index.css?version=2.0.0"><link rel="stylesheet" href="/font/fontello.css?version=2.0.0"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Fira+Mono|Noto+Serif+SC&amp;amp;display=swap"><link rel="canonical" href="//sanshiliuxiao.top"><link rel="dns-prefetch" href="//cdn.jsdelivr.net"><script src="/lib/waline/waline.min.js"> </script></head><body><div class="layout"><header><div id="header"><div class="mobile-bg" style="background-image:url(https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/mobile.png);"></div><h1 class="title">椎咲良田</h1><h2 class="subtitle">快走吧 趁风停止之前</h2><nav class="menu"><a class="menu-item pjax-main-link" href="/"><li><i class="icon-index"></i><span>首页</span></li></a><a class="menu-item pjax-main-link" href="/archives/"><li><i class="icon-archives"></i><span>归档</span></li></a><a class="menu-item pjax-main-link" href="/categories/"><li><i class="icon-categories"></i><span>分类</span></li></a><a class="menu-item pjax-main-link" href="/tags/"><li><i class="icon-tags"></i><span>标签</span></li></a><a class="menu-item pjax-main-link" href="/books/"><li><i class="icon-books"></i><span>书单</span></li></a><a class="menu-item pjax-main-link" href="/inspirations/"><li><i class="icon-inspiration"></i><span>灵感</span></li></a><a class="menu-item pjax-main-link" href="/friends/"><li><i class="icon-friends"></i><span>友链</span></li></a><a class="menu-item pjax-main-link" href="/about/"><li><i class="icon-about"></i><span>关于</span></li></a></nav></div></header><main><div class="main-wrapper"></div><div class="pjax-main-page"><div class="post"><article class="post-article"><div class="post-header"><img class="default-image" src="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/postDefaultImage .png" style="opacity:0;"><img class="post-image" src="https://i.loli.net/2020/10/09/cndOPy92SJGXaID.jpg"><div class="post-head"><div class="post-title-wrapper"><h1 class="post-title">你的日记导出工具</h1></div><div class="post-meta"><span class="post-date"><i class="icon-calendar"></i><span class="date timeago" datetime="2020-10-09T08:09:30.000Z"></span></span><span class="post-hot"><i class="icon-fire"></i><span class="leancloud_visitors" id="/notebook/CSharp/20201009-你的日记导出工具/" data-flag-title="你的日记导出工具">热度<span class="leancloud-visitors-count">0</span>℃</span></span><span class="post-tags"><i class="icon-tag"></i><span class="tag">CSharp</span><span class="tag">WPF</span></span><span class="post-categories"><i class="icon-bookmark-empty"></i><span class="category">笔记本</span></span></div></div></div><div class="post-content heti"><div class="markdown"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><a href="https://www.coolapk.com/apk/com.oh_name" target="_blank" rel="noopener">你的日记</a> 是一个非常好用的日记 APP，开发者受到动漫《你的名字》的启发，从而制作出这款精良日记软件。</p>
<p>本人使用此软件大概两年了。虽然我有使用 APP 的时空旋涡功能，匹配到了一位好友，但大多数情况下，我基本不会和对方互动，只是零星会回复一些简短的话语。日记这种私密的东西，一旦掺杂了要与对面的人分享日记的心情，那往往会在记录的日记中加以掩饰，变得日记不是日记。因此，我个人的想法是：真正的日记笔友，应该是永远不会在现实生活中所接触到，写日记真的就只是为了给自己做记录，不是为了别的什么原因。</p>
<p>话题扯远了，回归主题，就是这样一款优秀的，可作为”交友”的日记软件，<strong>可是却迟迟没有推出日记的导出功能？？？</strong></p>
<p>不怕，借助万能的 GitHub，咱搜索到一个项目： <a href="https://github.com/YunYouJun/export-nideriji" target="_blank" rel="noopener">YunYouJun/export-nideriji</a>。这是一个基于 nodejs 的命令行工具，如果作为一名对计算机有了解的人来说，使用起来一点都不困难。感谢 <a href="https://github.com/YunYouJun" target="_blank" rel="noopener">云游君</a> 的项目及其 API 文档。</p>
<p>作为偶尔爱折腾（长期鸽子）的本人，决定使用 CSharp 来重写一遍这个项目，把它演化成一个易于使用的桌面工具。</p>
<h2 id="太长不看版"><a href="#太长不看版" class="headerlink" title="太长不看版"></a>太长不看版</h2><blockquote>
<p> Github 地址： [DiaryExport] (<a href="https://github.com/sanshiliuxiao/DiaryExport" target="_blank" rel="noopener">https://github.com/sanshiliuxiao/DiaryExport</a>)</p>
</blockquote>

    <div class="img-box">
      <img class="img-zoomable" src="0.png">
      <span>◭ 软件运行效果</span>
    </div>
  


<h2 id="实现细节"><a href="#实现细节" class="headerlink" title="实现细节"></a>实现细节</h2><p>通过查看 export-nideriji 项目的源代码，我们能够知道如下几点：</p>
<ol>
<li>如何进行登陆以及维持登陆状态。</li>
</ol>
<ol start="2">
<li><p>通过本篇日记的 ID， 能够获取到上一篇的日记。</p>
</li>
<li><p>日记存在被自己删除的情况，数据库有记录，能够获取到数据字段，只是内容显示 <code>deleted</code>。</p>
</li>
</ol>
<p>基于上面这几点，就非常清晰的知道如何去导出日记，剩下的事情就是使用另外一种语言去实现这些功能呢。 </p>
<h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3>
    <div class="img-box">
      <img class="img-zoomable" src="1.png">
      <span>◭ 项目结构</span>
    </div>
  

<ul>
<li><p>第一个项目：通过命令行方式去导出日记，用于测试使用。 （为了方便，其实我是直接把账号密码写在代码里的，不过使用 git 前，我就删掉了）。</p>
</li>
<li><p>第二个项目：用于获取数据。</p>
</li>
<li><p>第三个项目：用于将获取到的数据，最终导出成文件。</p>
</li>
<li><p>第四个项目： WPF 桌面应用。</p>
</li>
</ul>
<h3 id="数据获取"><a href="#数据获取" class="headerlink" title="数据获取"></a>数据获取</h3><p>使用 <code>Flurl.Http</code> 进行登陆和数据的获取，使用 <code>Polly</code> 进行连接失败的再次尝试。他们的使用方式都很简单，直接拷贝文档里面的例子，稍微改改就行。</p>
<p>C# 的泛型和委托是真的好用，下面是一个示例，功能是网络连接失败后，等待几秒后进行尝试的函数。如果请求成功则会返回 data 数据。 由于 <code>T</code> 是泛型语法，那么 data 数据的类型就能够通过传入的 <code>Model Class</code> 进行改变啦。</p>
<pre><code class="CSharp">public class DiaryExport
{
     private List&lt;int&gt; httpStatusCodesWorthRetrying = new List&lt;int&gt;(new[] { 408, 500, 502, 503, 504 });
    public async Task&lt;T&gt; RetryPolicy&lt;T&gt;(Func&lt;Task&lt;T&gt;&gt; request)
    {
        var retryCount = 0;
        T data;
        data = await Policy
            .Handle&lt;FlurlHttpException&gt;(ex =&gt;
            {
                // 这里由于网络断开连接了，所以 Response 为 null 
                if (ex.Call.Response == null)
                {
                    return true;
                }

                return httpStatusCodesWorthRetrying.Contains((int) ex.Call.Response.StatusCode);
            })
            .WaitAndRetryAsync(new[]
            {
                TimeSpan.FromSeconds(1),
                TimeSpan.FromSeconds(3),
                TimeSpan.FromSeconds(6)
            })
            .ExecuteAsync(() =&gt;
            {

                retryCount++;
                return request();
            });
        return data;
    }
｝


// 使用
userModel = await RetryPolicy&lt;UserModel&gt;(() =&gt; 
    new Url(_baseUrl)
        .AppendPathSegment(&quot;/login/&quot;)
        .PostUrlEncodedAsync(data)
        .ReceiveJson&lt;UserModel&gt;());</code></pre>
<p>对于 CSharp 这类静态类型语言来说， 获取到 <code>JSON</code> 数据之后，是需要有一个与之对应 <code>Model Class</code> 才能够进行解析的,而且 <code>JSON</code> 里面键值开头是小写，而 <code>Model Class</code> 对应的属性开头是大写。（这属于命名规范，其实不强制。除了第一个字母（大小不分），其余字母是区分大小写的）。</p>
<p>这样看来，确实有些麻烦，不过有一点好处是不需要的数据，可以不写在 <code>Model Class</code> 中。下面是示例：</p>
<pre><code class="CSharp">
// json data
{
    &quot;token&quot;: &quot;xxx&quot;,
    &quot;user_config&quot;: {
        &quot;name&quot;: &quot;yyy&quot;,
        &quot;useremail&quot;: &quot;zzz&quot;,
        &quot;description&quot;: &quot;如果 Model Class 里面没有这个属性，就不会映射进去&quot;
    }
}


// Model Class
public class UserModel
{
    public string Token { get; set; } // 也可以写 token， 但不能写 TokEn tokEn 之类的。
    public UserInfo User_config { get; set; } // User_config 名字要对的上
}

public class UserInfo
{
    public string Name { get; set; }
    public string Useremail { get; set; }
}
</code></pre>
<p>至于如何将 <code>JSON</code> 数据转换成 <code>CSharp 的 Model Class</code>, 这里不多赘述， 因为 <code>Flurl.Http</code> 自带 <code>ReceiveJson()</code> 方法进行转换。 如果想用其他库的话，推荐使用 <code>Newtonsoft.josn</code>。</p>
<h2 id="数据存储"><a href="#数据存储" class="headerlink" title="数据存储"></a>数据存储</h2><p>这里也蛮简单的，网上找几篇博客，拷贝一下代码，改改就能用了。其实导出方式大同小异。</p>
<pre><code class="Csharp">
// 省略部分代码，其中 _diaryInfos 为数据源 ，_filePath 为导出路径

public void ExportToJSONFile()
{
    var fileInfo = new FileInfo(_filePath);

    if (fileInfo.Extension == string.Empty)
    {
        _filePath = $@&quot;{_filePath}\ExportDiary.json&quot;;
    }

    // 来自 Newtonsoft.json 的函数
    string json = JsonConvert.SerializeObject(_diaryInfos, Formatting.Indented);

    // 不存在文件，新建并写入
    // 存在文件， 覆盖写入
    // 自动关闭文件句柄，防止占用。
    File.WriteAllText(_filePath, json, Encoding.UTF8);
}</code></pre>
<h2 id="桌面应用"><a href="#桌面应用" class="headerlink" title="桌面应用"></a>桌面应用</h2><p>这部分其实写起来还蛮有意思的，因为很久没写 WPF，我又忘记了怎么去写了。</p>
<p>这里我稍微用到了点 MVVM 的东西，然而为了偷懒，我真的就只用了一点点。因为导出时，要是没有提示就太难受了，所以就需要在导出的过程中不断的进行提示。</p>
<p>由于在没写 WPF 前，使用 <code>diaryExport.ExportAllDiaryInfo()</code> 得到所有的数据。这就与我上面的需求点矛盾了啊！ 于是乎，委托又立了大功。步骤如下：</p>
<ol>
<li>使用 WPF 提供的 MVVM 功能，将页面和提示（用一个数组就行）连接起来，数据变化，页面也变化。</li>
<li>更改 <code>ExportAllDiaryInfo()</code> 方法，使之变成<code>ExportAllDiaryInfo(Action&lt;string&gt; UiTip)</code>, 这样就能改变数据，进一步改变页面显示。</li>
</ol>
<p>选中导出目录的功能可以使用 <code>Ookii.Dialogs.Wpf.NETCore</code>（针对 <code>.NET Core</code>） 或者 <code>Ookii.Dialogs.Wpf</code>(针对 <code>.NET Framework</code> )。 要是我想同时生成这两种不同的程序要怎么办呢？？？ 有办法的，在项目的属性中进行修改。</p>
<pre><code class="XML">
&lt;Project Sdk=&quot;Microsoft.NET.Sdk.WindowsDesktop&quot;&gt;

  &lt;PropertyGroup&gt;
      &lt;OutputType&gt;WinExe&lt;/OutputType&gt;

      // 这里需要由 TargetFramework 改成 TargetFrameworks

      &lt;TargetFrameworks&gt;netcoreapp3.1;net472;&lt;/TargetFrameworks&gt;
    &lt;UseWPF&gt;true&lt;/UseWPF&gt;

    &lt;/PropertyGroup&gt;

    // 不能这样写，因为 Ookii.Dialogs.Wpf 不适用于 .NET Core
    // &lt;ItemGroup Include=&quot;Ookii.Dialogs.Wpf&quot; Version=&quot;1.1.0&quot; /&gt;

    // 因此可以分别引入不同的包
    // 只要他们的 API 是相同的，那么代码里就无须做任何修改，即可兼容。
    &lt;ItemGroup Condition=&quot; &#39;$(TargetFramework)&#39; == &#39;net472&#39; &quot;&gt;
        &lt;PackageReference Include=&quot;Ookii.Dialogs.Wpf&quot;&gt;
            &lt;Version&gt;1.1.0&lt;/Version&gt;
        &lt;/PackageReference&gt;
    &lt;/ItemGroup&gt;

    &lt;ItemGroup Condition=&quot;&#39;$(TargetFramework)&#39; == &#39;netcoreapp3.1&#39;&quot;&gt;
      &lt;PackageReference Include=&quot;Ookii.Dialogs.Wpf.NETCore&quot;&gt;
        &lt;Version&gt;2.1.0&lt;/Version&gt;
      &lt;/PackageReference&gt;
    &lt;/ItemGroup&gt;

    &lt;ItemGroup&gt;
    &lt;ProjectReference Include=&quot;..\DiaryExport.Core\DiaryExport.Core.csproj&quot; /&gt;
    &lt;ProjectReference Include=&quot;..\DiaryExport.ExportDiaryToFile\DiaryExport.ExportDiaryToFile.csproj&quot; /&gt;
  &lt;/ItemGroup&gt;


&lt;/Project&gt;</code></pre>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>还能拓展的功能有很多，但是我想我又得鸽一阵子了，反正这工具又不是不能用。 </p>
<h2>Google广告</h2><div class="google-ads-post-wrapper"><div class="google-seat"><p>假装这里有广告</p></div><div class="google-ads-content"></div></div></div></div></article></div><div class="waline-wrapper"><div id="waline"></div></div><script>var valine = new Waline({
    el: '#waline',
    serverURL: 'https://waline-comments-seven.vercel.app/', 
})</script></div><div class="pjax-main-loading loading"><img class="loading-image" src="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/loading.gif"></div></main><footer><div class="footer site-info"><p><i class="icon-copyright"></i><span>2018</span>&minus;<span>2021</span>&nbsp;&nbsp;&nbsp;<i class="icon-heart"></i>&nbsp;&nbsp;<span>椎咲良田</span></p><p><a href="https://github.com/sanshiliuxiao/hexo-theme-aurora.git" target="_blank">hexo-theme-Aurora</a>&nbsp; | &nbsp;快走吧 趁风停止之前</p></div></footer></div><div id="sakura-panel"><img class="sakura-icon" src="https://i.loli.net/2020/12/27/rPA2XaEJsnq5UIC.png" alt="sakura"><div class="sakura-mask"></div><div class="sakura-container"><div class="wrapper"><div class="short-line"><div class="line"></div><div class="line"></div></div><div class="main"><div class="body"><div class="swiper-wrapper"><ul class="swiper"><li class="swiper-item"><div class="header"><h2>联系方式</h2></div><div class="container"><div class="item"><h3>Q Q</h3><img class="qr-code" src="/images/qq.png"></div><div class="item"><h3>微信</h3><img class="qr-code" src="/images/vx.png"></div></div></li></ul></div></div><div class="footer"><p class="like"><span>已有 </span><span class="like-num leancloud-app-like">0</span><span> 人点赞了哦！</span></p><div class="star" data-title="点赞一下 (&lt;ゝω・)☆"></div></div></div><div class="long-line"><div class="line"></div><div class="line"></div></div></div></div></div><div class="bg"><div class="pc-dynamic-bg"><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/1.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/2.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/3.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/4.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/5.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/6.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/7.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/8.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/9.jpg"></span></div></div><span class="back-to-top"></span><div class="leancloud"><script src="/js/third-party/leancloud.min.js?version=2.0.0"></script><div class="leancloud-app-id" leancloud-app-id="QAIKomD08e9fmVRQP4tkzUDf-MdYXbMMI"></div><div class="leancloud-app-key" leancloud-app-key="vi0TViY0HvYocUR3HxKGd1l9"></div><div class="leancloud-app-hot"></div><div class="leancloud-app-visitor"></div></div><script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" data-ad-client="ca-pub-9441161448418285"></script><div class="google-ads-ad-client" data-ads-ad-client="ca-pub-9441161448418285"></div><div class="google-ads-post-page" data-ads-solt="3867936552"></div><div class="google-ads-about-page" data-ads-solt="6860833347"></div><link rel="stylesheet" href="/lib/APlayer/APlayer.min.css"><script src="/lib/APlayer/APlayer.min.js"></script><div id="aplayer"></div><script>let list = JSON.parse('[{"name":"Once more","artist":"阿保剛","url":"https://files.catbox.moe/13boxb.mp3","cover":"https://i.loli.net/2019/04/18/5cb87157c617e.jpg"},{"name":"All or None","artist":"阿保剛","url":"https://files.catbox.moe/4x69y9.mp3","cover":"https://i.loli.net/2019/04/18/5cb87157b537a.jpg"},{"name":"Karma","artist":"阿保剛","url":"https://files.catbox.moe/r5dsuh.mp3","cover":"https://i.loli.net/2019/04/18/5cb871583cfb7.jpg"},{"name":"星の奏でる歌","artist":"阿保剛","url":"https://files.catbox.moe/m1wd57.mp3","cover":"https://i.loli.net/2019/04/18/5cb871585123b.jpg"}]')
  const ap = new APlayer({
      container: document.getElementById('aplayer'),
      theme: '#b28fce',
      audio: list,
      fixed: true
  });
  ap.list.show()
</script><script src="/js/third-party/jquery.min.js?version=2.0.0"></script><script src="/js/third-party/isMobile.min.js?version=2.0.0"></script><script src="/js/third-party/timeago.min.js?version=2.0.0"></script><script src="/js/third-party/pjax.min.js?version=2.0.0"></script><script src="/js/third-party/zooming.min.js?version=2.0.0"></script><script src="/js/third-party/backstretch.min.js?version=2.0.0"></script><script src="/js/highlight.min.js?version=2.0.0"></script><script src="/js/index.js?version=2.0.0"></script></body></html>