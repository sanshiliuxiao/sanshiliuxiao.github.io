<!DOCTYPE html><html lang="ZH-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="referrer" content="no-referrer"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1,user-scalable=no,viewport-fit=cover"><meta name="author" content="椎咲良田"><meta name="copyright" content="椎咲良田"><meta name="og:image" content="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/avatar.jpg"><meta name="og:type" content="website"><meta name="og:site_name" content="椎咲良田"><meta name="og:url" content="sanshiliuxiao.top"><meta name="og：title" content="椎咲良田"><meta name="theme-color" content="#b854d4"><title>椎咲良田</title><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/favicon.jpg" type="image/x-icon"><link rel="stylesheet" href="/css/index.css?version=2.0.0"><link rel="stylesheet" href="/font/fontello.css?version=2.0.0"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Fira+Mono|Noto+Serif+SC&amp;amp;display=swap"><link rel="canonical" href="//sanshiliuxiao.top"><link rel="dns-prefetch" href="//cdn.jsdelivr.net"><link rel="stylesheet" href="/lib/gitalk/gitalk.min.css"><script src="/lib/gitalk/gitalk.min.js"></script></head><body><div class="layout"><header><div class="header"><div class="mobile-bg" style="background-image:url(https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/mobile.png);"></div><h1 class="title">椎咲良田</h1><h2 class="subtitle">快走吧 趁风停止之前</h2><nav class="menu"><a class="menu-item pjax-main-link" href="/"><li><i class="icon-index"></i><span>首页</span></li></a><a class="menu-item pjax-main-link" href="/archives/"><li><i class="icon-archives"></i><span>归档</span></li></a><a class="menu-item pjax-main-link" href="/categories/"><li><i class="icon-categories"></i><span>分类</span></li></a><a class="menu-item pjax-main-link" href="/tags/"><li><i class="icon-tags"></i><span>标签</span></li></a><a class="menu-item pjax-main-link" href="/books/"><li><i class="icon-books"></i><span>书单</span></li></a><a class="menu-item pjax-main-link" href="/inspirations/"><li><i class="icon-inspiration"></i><span>灵感</span></li></a><a class="menu-item pjax-main-link" href="/friends/"><li><i class="icon-friends"></i><span>友链</span></li></a><a class="menu-item pjax-main-link" href="/about/"><li><i class="icon-about"></i><span>关于</span></li></a></nav></div></header><main><div class="main-wrapper"></div><div class="pjax-main-page"><div class="post"><article class="post-article"><div class="post-header"><img class="default-image" src="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/postDefaultImage .png" style="opacity:0;"><img class="post-image" src="https://i.loli.net/2019/04/20/5cbaa3329d8f9.jpg"><div class="post-head"><div class="post-title-wrapper"><h1 class="post-title">主题更新记</h1></div><div class="post-meta"><span class="post-date"><i class="icon-calendar"></i><span class="date timeago" datetime="2019-04-20T04:30:15.000Z"></span></span><span class="post-hot"><i class="icon-fire"></i><span class="leancloud_visitors" id="/talkSelf/20190420-主题更新记/" data-flag-title="主题更新记">热度<span class="leancloud-visitors-count">0</span>℃</span></span><span class="post-tags"><i class="icon-tag"></i><span class="tag">说说</span></span><span class="post-categories"><i class="icon-bookmark-empty"></i><span class="category">自言语</span></span></div></div></div><div class="post-content"><div class="markdown"><h2 id="亮点"><a href="#亮点" class="headerlink" title="亮点"></a>亮点</h2><ul>
<li>使用 pjax 重写了主题，让页面部分加载，加快网页的速度</li>
<li>新增页面加载动画</li>
<li>新增 Aplayer 播放器</li>
<li>新增访问来源功能，借鉴(<del>拷贝修改</del>) <a href="https://chanshiyu.com/#/post/50" target="_blank" rel="noopener">主题集成友链访问统计</a> </li>
<li>使用 medium-zoom 展示文章图片</li>
<li><del>优化代码的组织方式</del></li>
</ul>
<h2 id="bug-解决"><a href="#bug-解决" class="headerlink" title="bug 解决"></a>bug 解决</h2><h3 id="pjax-与-highligh-js-渲染问题"><a href="#pjax-与-highligh-js-渲染问题" class="headerlink" title="pjax 与 highligh.js 渲染问题"></a>pjax 与 highligh.js 渲染问题</h3><p>highligh.js 是 代码高亮的插件，它有这样一个函数方式 <code>initHighlighting</code>，用来初始化。</p>
<p>当使用 pjax 进行跳转文章，重新调用了上面的函数，还是发现文章中代码块没有被渲染成功。<br>猜测是不是要重新请求 highligh.js，才能重新初始化，搜索到的解决办法也印证了自己的想法。最开始搜索到的方法：每一次 pjax 请求完成后，重新请求 highligh.js 文件，再使用 <code>initHighlighting</code> 进行初始化。</p>
<p>上面的方法，导致每次都需要重新初始化，会浪费时间，又重新调整了搜索关键词<br>最后使用的方法来源自这条 issues :<a href="https://github.com/highlightjs/highlight.js/issues/287" target="_blank" rel="noopener">Highlighting doesn’t trigger when using PJAX</a>，其实只需要使用 <code>highlightBlock</code> 方法就可以完美解决。 </p>
<pre><code class="js">  // 重新渲染代码块 
document.querySelectorAll(&#39;pre code&#39;).forEach((block) =&gt; {
  hljs.highlightBlock(block);
});</code></pre>
<p><del>其实这个方法，就写在文档里了，只是咱当时认为只有 initHighlighting 才能够渲染。</del></p>
<h3 id="pjax-失效"><a href="#pjax-失效" class="headerlink" title="pjax 失效"></a>pjax 失效</h3><p>正是由于使用 pjax ，让咱找了一天的 bug。</p>
<p>问题是这样被咱发现的，在本地预览时，pjax 可以正常的工作，可将博客部署到 github 上后，却发现没有切换页面时的动画加载效果，打开控制台，发现浏览器并有红色的 pjax 请求，而且一闪而过，整个页面重新请求，并没有达到 pjax 部分加载的功能。</p>
<p>咱意识到大概是那个 pjax 请求并没有成功，于是咱先把 网络速度跳慢（slow 3G），然后使用咱的手速，终于截取到了错误信息<br><img src="1.png" alt></p>
<p>可以看到关键的错误信息 <code>blocked:mixed-content</code>，打开了万能的谷歌引擎，得到的信息如下：</p>
<p><a href="https://developers.google.com/web/fundamentals/security/prevent-mixed-content/fixing-mixed-content?hl=zh-cn" target="_blank" rel="noopener">防止混合内容</a>：大概意思就是网页中混合着 http 请求 和 https 请求，这会使网页变得不安全，所以会被浏览器拦截掉。</p>
<p>文中给出的解决办法是添加一个 meta 标签去自动修正混合内容。</p>
<pre><code class="html">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;upgrade-insecure-requests&quot;&gt;</code></pre>
<p>不过，在本地预览时 <code>http://hostlocal:4000</code> 会产生一些奇奇怪怪的问题！！！，因为这个页面是 http 请求，暂时没想到办法解决。</p>
<h4 id="20190423-更新"><a href="#20190423-更新" class="headerlink" title="20190423 更新"></a>20190423 更新</h4><p>我发现 pjax 失效的真正原因了，原来是因为配置文件页面路径配置存在问题。</p>
<pre><code class="yml"># 最初配置
  archives:
    name: 归档
    url: /archives
    icon: icon-archives

# 最后配置
  archives:
    name: 归档
    url: /archives/
    icon: icon-archives</code></pre>
<p>最关键的就在这 <code>/</code> 之间。</p>
<p>先来看看最开始错误的情况，这次勾选上了 <strong><code>preserve log</code></strong> 选项，再也不要拼手速了。</p>
<p><img src="2.png" alt></p>
<p>可以看到，这个 http 请求的构成 <code>/archives?_pjax=.paga-main-page</code>，返回了 302 状态码，也就是重定向了，于是重新请求了 <code>/archives/</code>，导致了 pjax 的失效。</p>
<p>所以当我重新配置好之后，这个问题，就解决啦！！！</p>
<p><img src="3.png" alt></p>
<p>这样本地预览的时候，可以正常的使用 pjax 功能啦，尝试重新生成推送到 Github 后进行访问测试，也没有问题。</p>
<p>其根本原因在于当服务器接收到某个末尾不含 <code>/</code> 的 URL 请求时，比如 <code>http://localhost:5000/archives</code> 服务器会先搜索网站的根目录里面有没有 <code>archives</code> 文件，如果没有，就会把 <code>archives</code> 当成目录进行处理，然后返回 <code>archives</code> 目录下的默认首页，也即 <code>http://localhost:5000/archives/</code>(等同于<code>http://localhost:5000/archives/index.html</code>）</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>可能还会因为自己的水平有限，这个主题存在一些其他的 bug 没有被发现，先暂时记录这么多了。</p>
</div></div></article></div><div id="gitalk"></div><script>var gitalk = new Gitalk({
    clientID: '921d6f0be7c36e212658',
    clientSecret: '2614ce5f405d03d99d9b76da0dc0a6f75b376bd9',
    id: '2019-04-20 12:30:15',
    repo: 'comments',
    owner: 'sanshiliuxiao',
    admin: 'sanshiliuxiao'
})
gitalk.render('gitalk')</script></div><div class="pjax-main-loading loading"><img class="loading-image" src="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/loading.gif"></div></main><footer><div class="footer site-info"><p><i class="icon-copyright"></i><span>2018</span>&minus;<span>2020</span>&nbsp;&nbsp;&nbsp;<i class="icon-heart"></i>&nbsp;&nbsp;<span>椎咲良田</span></p><p><a href="https://github.com/sanshiliuxiao/hexo-theme-aurora.git" target="_blank">hexo-theme-Aurora</a>&nbsp; | &nbsp;快走吧 趁风停止之前</p></div></footer></div><div class="bg"><div class="pc-dynamic-bg"><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/1.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/2.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/3.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/4.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/5.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/6.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/7.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/8.jpg"></span><span class="image" data-image="https://cdn.jsdelivr.net/gh/sanshiliuxiao/blog-static/theme/9.jpg"></span></div></div><span class="back-to-top"></span><div class="leancloud"><script src="/js/third-party/leancloud.min.js?version=2.0.0"></script><div class="leancloud-app-id" leancloud-app-id="QAIKomD08e9fmVRQP4tkzUDf-MdYXbMMI"></div><div class="leancloud-app-key" leancloud-app-key="vi0TViY0HvYocUR3HxKGd1l9"></div><div class="leancloud-app-hot"></div><div class="leancloud-app-visitor"></div></div><link rel="stylesheet" href="/lib/APlayer/APlayer.min.css"><script src="/lib/APlayer/APlayer.min.js"></script><div id="aplayer"></div><script>let list = JSON.parse('[{"name":"Once more","artist":"阿保剛","url":"https://files.catbox.moe/13boxb.mp3","cover":"https://i.loli.net/2019/04/18/5cb87157c617e.jpg"},{"name":"All or None","artist":"阿保剛","url":"https://files.catbox.moe/4x69y9.mp3","cover":"https://i.loli.net/2019/04/18/5cb87157b537a.jpg"},{"name":"Karma","artist":"阿保剛","url":"https://files.catbox.moe/r5dsuh.mp3","cover":"https://i.loli.net/2019/04/18/5cb871583cfb7.jpg"},{"name":"星の奏でる歌","artist":"阿保剛","url":"https://files.catbox.moe/m1wd57.mp3","cover":"https://i.loli.net/2019/04/18/5cb871585123b.jpg"}]')
  const ap = new APlayer({
      container: document.getElementById('aplayer'),
      theme: '#b28fce',
      audio: list,
      fixed: true
  });
  ap.list.show()
</script><script src="/js/third-party/jquery.min.js?version=2.0.0"></script><script src="/js/third-party/isMobile.min.js?version=2.0.0"></script><script src="/js/third-party/timeago.min.js?version=2.0.0"></script><script src="/js/third-party/pjax.min.js?version=2.0.0"></script><script src="/js/third-party/zooming.min.js?version=2.0.0"></script><script src="/js/third-party/backstretch.min.js?version=2.0.0"></script><script src="/js/highlight.min.js?version=2.0.0"></script><script src="/js/index.js?version=2.0.0"></script></body></html>